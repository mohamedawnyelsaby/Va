// prisma/schema.prisma
// âœ… COMPLETE DATABASE SCHEMA

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USER MANAGEMENT
// ========================================

model User {
  id                       String    @id @default(cuid())
  email                    String    @unique
  password                 String?
  name                     String?
  phone                    String?   @unique
  avatar                   String?
  bio                      String?
  locale                   String    @default("en")
  theme                    String    @default("system")
  timezone                 String    @default("UTC")
  
  // Email Verification
  isVerified               Boolean   @default(false)
  emailVerified            DateTime?
  emailVerificationToken   String?   @unique
  emailVerificationExpiry  DateTime?
  
  // Password Reset
  passwordResetToken       String?   @unique
  passwordResetExpiry      DateTime?
  
  // Security
  isActive                 Boolean   @default(true)
  lastLoginAt              DateTime?
  lastLoginIp              String?
  loginAttempts            Int       @default(0)
  lockedUntil              DateTime?
  
  // Two-Factor Authentication
  twoFactorEnabled         Boolean   @default(false)
  twoFactorSecret          String?
  backupCodes              String?
  
  // Pi Network
  piWalletId               String?   @unique
  piUsername               String?
  piBalance                Float     @default(0)
  
  // Loyalty Program
  loyaltyPoints            Int       @default(0)
  loyaltyTier              String    @default("bronze") // bronze, silver, gold, platinum
  
  // Referral System
  referralCode             String    @unique @default(cuid())
  referredById             String?
  
  // Timestamps
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  
  // Relations
  referredBy               User?                @relation("Referrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals                User[]               @relation("Referrals")
  sessions                 Session[]
  accounts                 Account[]
  bookings                 Booking[]
  reviews                  Review[]
  favorites                Favorite[]
  preferences              Preference?
  notifications            Notification[]
  payments                 Payment[]
  piTransactions           PiTransaction[]
  apiKeys                  ApiKey[]
  auditLogs                AuditLog[]
  securityLogs             SecurityLog[]

  @@index([email])
  @@index([piWalletId])
  @@index([referralCode])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Preference {
  id                    String   @id @default(cuid())
  userId                String   @unique
  currency              String   @default("USD")
  language              String   @default("en")
  notificationsEnabled  Boolean  @default(true)
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(true)
  smsNotifications      Boolean  @default(false)
  marketingEmails       Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("preferences")
}

// ========================================
// LOCATION & GEOGRAPHY
// ========================================

model City {
  id          String   @id @default(cuid())
  name        String
  country     String
  countryCode String
  description String?
  latitude    Float
  longitude   Float
  timezone    String   @default("UTC")
  currency    String   @default("USD")
  language    String   @default("en")
  isPopular   Boolean  @default(false)
  isActive    Boolean  @default(true)
  images      String[]
  thumbnail   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  hotels      Hotel[]
  attractions Attraction[]
  restaurants Restaurant[]
  services    Service[]

  @@unique([name, country])
  @@index([isPopular])
  @@index([country])
  @@map("cities")
}

// ========================================
// HOTELS
// ========================================

model Hotel {
  id               String   @id @default(cuid())
  name             String
  description      String
  shortDescription String?
  address          String
  city             String
  cityId           String
  country          String
  postalCode       String?
  latitude         Float
  longitude        Float
  starRating       Int      @default(3)
  amenities        String[]
  roomTypes        Json[]
  pricePerNight    Float
  currency         String   @default("USD")
  checkInTime      String   @default("14:00")
  checkOutTime     String   @default("12:00")
  cancellationPolicy String?
  images           String[]
  thumbnail        String?
  isFeatured       Boolean  @default(false)
  isActive         Boolean  @default(true)
  rating           Float?   @default(0)
  reviewCount      Int      @default(0)
  discountRate     Float?   @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cityRelation City       @relation(fields: [cityId], references: [id])
  bookings     Booking[]
  reviews      Review[]
  favorites    Favorite[]

  @@index([cityId])
  @@index([isFeatured])
  @@index([rating])
  @@index([pricePerNight])
  @@map("hotels")
}

// ========================================
// ATTRACTIONS
// ========================================

model Attraction {
  id               String   @id @default(cuid())
  name             String
  description      String
  shortDescription String?
  category         String
  subcategory      String?
  address          String
  city             String
  cityId           String
  country          String
  latitude         Float
  longitude        Float
  ticketPrice      Float?
  currency         String   @default("USD")
  openingHours     Json?
  duration         String?
  bestTimeToVisit  String?
  accessibility    String[]
  images           String[]
  thumbnail        String?
  isPopular        Boolean  @default(false)
  isActive         Boolean  @default(true)
  rating           Float?   @default(0)
  reviewCount      Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cityRelation City       @relation(fields: [cityId], references: [id])
  bookings     Booking[]
  reviews      Review[]
  favorites    Favorite[]

  @@index([cityId])
  @@index([category])
  @@index([isPopular])
  @@index([rating])
  @@map("attractions")
}

// ========================================
// RESTAURANTS
// ========================================

model Restaurant {
  id               String   @id @default(cuid())
  name             String
  description      String
  cuisine          String[]
  priceRange       String   // $, $$, $$$, $$$$
  address          String
  city             String
  cityId           String
  country          String
  latitude         Float
  longitude        Float
  openingHours     Json?
  reservationRequired Boolean @default(false)
  dressCode        String?
  features         String[]
  images           String[]
  thumbnail        String?
  isFeatured       Boolean  @default(false)
  isActive         Boolean  @default(true)
  rating           Float?   @default(0)
  reviewCount      Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cityRelation City       @relation(fields: [cityId], references: [id])
  bookings     Booking[]
  reviews      Review[]
  favorites    Favorite[]

  @@index([cityId])
  @@index([isFeatured])
  @@index([rating])
  @@map("restaurants")
}

// ========================================
// SERVICES
// ========================================

model Service {
  id               String   @id @default(cuid())
  name             String
  description      String
  category         String   // Transport, Tour, Activity, etc.
  price            Float
  currency         String   @default("USD")
  duration         String?
  city             String
  cityId           String
  images           String[]
  thumbnail        String?
  isActive         Boolean  @default(true)
  rating           Float?   @default(0)
  reviewCount      Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cityRelation City       @relation(fields: [cityId], references: [id])
  bookings     Booking[]
  reviews      Review[]

  @@index([cityId])
  @@index([category])
  @@map("services")
}

// ========================================
// BOOKINGS
// ========================================

model Booking {
  id               String    @id @default(cuid())
  bookingCode      String    @unique @default(cuid())
  userId           String
  itemType         String    // Hotel, Attraction, Restaurant, Service
  hotelId          String?
  attractionId     String?
  restaurantId     String?
  serviceId        String?
  itemName         String
  startDate        DateTime
  endDate          DateTime?
  checkInDate      DateTime?
  checkOutDate     DateTime?
  guests           Int?      @default(1)
  rooms            Int?      @default(1)
  totalPrice       Float
  currency         String    @default("USD")
  piAmount         Float?
  discount         Float?    @default(0)
  tax              Float?    @default(0)
  serviceFee       Float?    @default(0)
  notes            String?
  specialRequests  String?
  status           String    @default("pending") // pending, confirmed, cancelled, completed
  paymentStatus    String    @default("pending") // pending, paid, refunded, failed
  paymentMethod    String?
  paymentId        String?
  piPaymentId      String?
  cancellationReason String?
  cancelledAt      DateTime?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  user             User      @relation(fields: [userId], references: [id])
  hotel            Hotel?    @relation(fields: [hotelId], references: [id])
  attraction       Attraction? @relation(fields: [attractionId], references: [id])
  restaurant       Restaurant? @relation(fields: [restaurantId], references: [id])
  service          Service?  @relation(fields: [serviceId], references: [id])
  payments         Payment[]

  @@index([userId])
  @@index([bookingCode])
  @@index([status])
  @@index([userId, status])
  @@index([createdAt])
  @@map("bookings")
}

// ========================================
// REVIEWS
// ========================================

model Review {
  id           String   @id @default(cuid())
  userId       String
  itemType     String   // Hotel, Attraction, Restaurant, Service
  hotelId      String?
  attractionId String?
  restaurantId String?
  serviceId    String?
  rating       Int      // 1-5
  title        String?
  comment      String
  images       String[]
  likes        Int      @default(0)
  isVerified   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User         @relation(fields: [userId], references: [id])
  hotel      Hotel?       @relation(fields: [hotelId], references: [id])
  attraction Attraction?  @relation(fields: [attractionId], references: [id])
  restaurant Restaurant?  @relation(fields: [restaurantId], references: [id])
  service    Service?     @relation(fields: [serviceId], references: [id])

  @@index([userId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

// ========================================
// FAVORITES
// ========================================

model Favorite {
  id           String   @id @default(cuid())
  userId       String
  itemType     String
  hotelId      String?
  attractionId String?
  restaurantId String?
  createdAt    DateTime @default(now())

  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  hotel      Hotel?       @relation(fields: [hotelId], references: [id])
  attraction Attraction?  @relation(fields: [attractionId], references: [id])
  restaurant Restaurant?  @relation(fields: [restaurantId], references: [id])

  @@unique([userId, itemType, hotelId])
  @@unique([userId, itemType, attractionId])
  @@unique([userId, itemType, restaurantId])
  @@index([userId])
  @@map("favorites")
}

// ========================================
// PAYMENTS
// ========================================

model Payment {
  id                    String   @id @default(cuid())
  userId                String
  bookingId             String?
  amount                Float
  currency              String   @default("USD")
  piAmount              Float?
  paymentMethod         String   // credit_card, pi_network, paypal
  status                String   @default("pending") // pending, completed, failed, refunded
  transactionId         String?  @unique
  piPaymentId           String?  @unique
  stripePaymentIntentId String?  @unique
  errorMessage          String?
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user                  User     @relation(fields: [userId], references: [id])
  booking               Booking? @relation(fields: [bookingId], references: [id])

  @@index([userId])
  @@index([bookingId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model PiTransaction {
  id            String   @id @default(cuid())
  userId        String
  type          String   // referral, cashback, purchase, withdrawal
  amount        Float
  description   String
  balanceAfter  Float
  status        String   @default("completed")
  piPaymentId   String?
  metadata      Json?
  createdAt     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([type])
  @@map("pi_transactions")
}

// ========================================
// NOTIFICATIONS
// ========================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // booking, payment, review, system, promotion
  title     String
  message   String
  data      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ========================================
// API & SECURITY
// ========================================

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  key         String   @unique
  name        String
  permissions String[]
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([userId])
  @@map("api_keys")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  changes    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model SecurityLog {
  id             String   @id @default(cuid())
  userId         String?
  action         String
  success        Boolean
  failureReason  String?
  ipAddress      String
  userAgent      String
  metadata       Json?
  createdAt      DateTime @default(now())
  
  user           User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([success])
  @@index([createdAt])
  @@index([ipAddress])
  @@map("security_logs")
}
