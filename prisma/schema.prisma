// prisma/schema.prisma - FIXED VERSION

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String    @id @default(cuid())
  email                    String    @unique
  password                 String?   // Nullable for OAuth users
  name                     String?
  phone                    String?
  avatar                   String?
  bio                      String?
  locale                   String    @default("en")
  theme                    String    @default("system")
  timezone                 String    @default("UTC")
  isVerified               Boolean   @default(false)
  isActive                 Boolean   @default(true)
  emailVerified            DateTime?
  emailVerificationToken   String?
  emailVerificationExpiry  DateTime?
  passwordResetToken       String?
  passwordResetExpiry      DateTime?
  lastLoginAt              DateTime?
  lastLoginIp              String?
  loginAttempts            Int       @default(0)
  lockedUntil              DateTime?
  piWalletId               String?   @unique
  piUsername               String?
  piBalance                Float     @default(0)
  loyaltyPoints            Int       @default(0)
  loyaltyTier              String    @default("bronze")
  referralCode             String    @unique @default(cuid())
  referredById             String?
  twoFactorEnabled         Boolean   @default(false)
  twoFactorSecret          String?
  backupCodes              String?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  
  // Relations
  referredBy               User?                @relation("Referrals", fields: [referredById], references: [id])
  referrals                User[]               @relation("Referrals")
  sessions                 Session[]
  accounts                 Account[]
  bookings                 Booking[]
  reviews                  Review[]
  favorites                Favorite[]
  preferences              Preference?
  notifications            Notification[]
  payments                 Payment[]
  piTransactions           PiTransaction[]
  apiKeys                  ApiKey[]
  auditLogs                AuditLog[]
  securityLogs             SecurityLog[]

  @@index([email])
  @@index([piWalletId])
  @@index([referralCode])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model Booking {
  id               String    @id @default(cuid())
  bookingCode      String    @unique @default(cuid())
  userId           String
  itemType         String    // Hotel, Attraction, Restaurant, Service
  hotelId          String?
  attractionId     String?
  restaurantId     String?
  serviceId        String?
  itemName         String
  startDate        DateTime
  endDate          DateTime?
  checkInDate      DateTime?
  checkOutDate     DateTime?
  guests           Int?      @default(1)
  rooms            Int?      @default(1)
  totalPrice       Float
  currency         String    @default("USD")
  piAmount         Float?
  discount         Float?    @default(0)
  tax              Float?    @default(0)
  serviceFee       Float?    @default(0)
  notes            String?
  specialRequests  String?
  status           String    @default("pending")
  paymentStatus    String    @default("pending")
  paymentMethod    String?
  paymentId        String?
  piPaymentId      String?
  cancellationReason String?
  cancelledAt      DateTime?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  // Relations
  user             User      @relation(fields: [userId], references: [id])
  hotel            Hotel?    @relation(fields: [hotelId], references: [id])
  attraction       Attraction? @relation(fields: [attractionId], references: [id])
  restaurant       Restaurant? @relation(fields: [restaurantId], references: [id])
  service          Service?  @relation(fields: [serviceId], references: [id])
  payments         Payment[]

  @@index([userId])
  @@index([bookingCode])
  @@index([status])
  @@index([userId, status])
  @@index([createdAt])
  @@index([hotelId])
  @@index([attractionId])
  @@index([restaurantId])
  @@map("bookings")
}

model Payment {
  id                    String   @id @default(cuid())
  userId                String
  bookingId             String?
  amount                Float
  currency              String   @default("USD")
  piAmount              Float?
  paymentMethod         String
  status                String   @default("pending")
  transactionId         String?  @unique
  piPaymentId           String?  @unique
  stripePaymentIntentId String?  @unique
  errorMessage          String?
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  user                  User     @relation(fields: [userId], references: [id])
  booking               Booking? @relation(fields: [bookingId], references: [id])

  @@index([userId])
  @@index([bookingId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model PiTransaction {
  id            String   @id @default(cuid())
  userId        String
  type          String   // referral, cashback, purchase, withdrawal
  amount        Float
  description   String
  balanceAfter  Float
  status        String   @default("completed")
  piPaymentId   String?
  metadata      Json?
  createdAt     DateTime @default(now())
  
  // Relations
  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([type])
  @@map("pi_transactions")
}

model SecurityLog {
  id             String   @id @default(cuid())
  userId         String?
  action         String
  success        Boolean
  failureReason  String?
  ipAddress      String
  userAgent      String
  metadata       Json?
  createdAt      DateTime @default(now())
  
  // Relations
  user           User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([success])
  @@index([createdAt])
  @@index([ipAddress])
  @@map("security_logs")
}

// ... (باقي الـ models كما هي مع إضافة indexes مناسبة)
